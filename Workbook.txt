' ワークブック(Excel)を開く
' 既に開かれている場合は、WBオブジェクトを返す。
'
' FileName : フルパスのファイル名
' Retval   : 0 = 正常終了(ファイルを開いてWBオブジェクトを返す)
'            1 = 正常終了(既に開いているWBオブジェクトを返す)
'            3 = ファイルなし (Nothing返す)
'            4 = ファルダなし (Nothing返す)
'            Other = Err.Number
' 戻り値   : 開いたWorkbookオブジェクト
'            Nothing = 見つからず'
' 参照設定 : Microsoft Scripting Runtime
'
Public Function WBOpenX(FPName As String, ByRef Retval As Long) As Workbook
    On Error GoTo ErrProc
    Dim FSO As FileSystemObject
    Dim s As String

    Set FSO = New FileSystemObject

    ' フォルダの存在チェック
    s = FSO.GetParentFolderName(FPName)
    If Not FSO.FolderExists(s) Then Retval = 4: GoTo EndProc

    ' ファイルの存在チェック
    If Not FSO.FileExists(FPName) Then Retval = 3: GoTo EndProc
    
    Set WBOpenX = IsWBOpen(FPName, 2)   ' 既に開かれているかチェック
    If Not WBOpenX Is Nothing Then
        Retval = 1  ' 既に開いていた
    Else
        Set WBOpenX = Workbooks.Open(FPName)    ' ファイルを開く
    End If
EndProc:
    Set FSO = Nothing
    Exit Function

ErrProc:
    Retval = Err.Number
    GoTo EndProc
End Function
